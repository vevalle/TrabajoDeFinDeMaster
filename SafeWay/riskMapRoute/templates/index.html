<!DOCTYPE HTML>

<html>

<head>
    {% load static %}

    <title>RiskMapRoute</title>

    <!-- CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/weather-icons.css'%}">
    <link rel="stylesheet" href="{% static 'css/font-awesome.css'%}">
    <link rel="stylesheet" href="{% static 'css/bootstrap-clockpicker.css'%}">
    <link rel="stylesheet" href="{% static 'css/bootstrap-datepicker.css'%}">
	<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
	<link rel="stylesheet" href="{% static 'css/style.css'%}">

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="{% static 'js/bootstrap-datepicker.js'%}" charset="UTF-8"></script>
    <script src="{% static 'js/bootstrap-datepicker.es.js'%}" charset="UTF-8"></script>
    <script src="{% static 'js/bootstrap-clockpicker.js'%}" charset="UTF-8"></script>
    <script src="{% static 'js/markerclusterer.js'%}" charset="UTF-8"></script>
    <script src="{% static 'js/js.cookie.js' %}"></script>
	
	<!-- Gráficos -->
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<script src="https://code.highcharts.com/modules/export-data.js"></script>
</head>

<body>
    <div class="container">
        <div class="row" id="principal">
            <div class="col-sm-12 col-md-3 infoPanel">

                <nav class="navbar navbar-default">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <a class="navbar-brand btn-form"> <b> Safeway </b> </a>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
									<span class="sr-only">Toggle navigation</span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
                        </div>

                        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <ul class="nav navbar-nav">
                                <li class="link"><a class="btn-form"> Ruta <span class="sr-only">(current)</span></a></li>
                                <li class="dropdown">
                                    <a href="#" class="dropdown-toggle link" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Configuracion<span class="caret"></span></a>
                                    <ul class="dropdown-menu">
                                        <li><a class="link" id="btn-divide">Dividir mapa</a></li>
                                        <li><a class="link" id="btn-configure">Establecer parametros</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <div class="row" id="panel-changes">
                    <div id='partition'>
                        <h4> Panel de configuración </h4>
                        <p> Se va a dividir el mapa en una matriz de n x n. </p>
                        <p> Por favor, indique el valor de n (min 4)</p>
                        <select class="form-control" id="numPart">
								<option>4</option>
								<option>5</option>
								<option>12</option>
								<option>7</option>
								<option>8</option>
							</select>
                        <button type="submit" id="btn-numParts" class="btn btn-primary btn-block">Aceptar</button>
                    </div>

                    <div id='loader'>
                        <h4> Panel de configuración </h4>
                        <p> Este proceso puede tardar unos minutos. </p>
                        <p> Por favor, espere </p>
                        <img src="{% static 'images/reload.gif'%}" width='45px' height='45px'>
                    </div>

                    <div id='success'>
                        <h4> Panel de configuración </h4>
                        <p> Proceso completado con éxito </p>
                        <button type="button" id="btn-continue" class="btn btn-success"> Continuar </button>
                    </div>

                    <div class="col-sm-12" id="configure">

                        <div class="form-config">
                            <label>Ubicación</label>
                            <p> Precisión del parámetro </p>
                                    <select class="form-control little" id="precision-location">
									<option>5 decimales (Ej. 51.13469) </option>
									<option>4 decimales (Ej. 51.1346)</option>
									<option>3 decimales (Ej. 51.134)</option>
									<option>2 decimales (Ej. 51.13)</option>
								</select>
                        </div>

                        <div class="form-config">
                            <label>Fecha de partida</label>
                            <p>Importancia del parámetro: <span id="value_fecha"></span></p>
                            <div class="slidecontainer">
                                <input class="slider" id="slider-fecha" type="range" min="0" max="100" value="100">
                            </div>
                            <p> Precisión del parámetro</p>
							<select class="form-control little" id="precision-dia">
								<option>Dia del mes (1, 2, 3, etc)</option>
								<option>Dia de la semana (Lunes, Martes, etc)</option>
								<option>Dia de diario / Fin de semana </option>
							</select>
                        </div>

                        <div class="form-config">
                            <label>Hora de partida</label>
                            <p>Importancia del parámetro: <span id="value_hora"></span></p>
                            <div class="slidecontainer">
                                <input class="slider" id="slider-hora" type="range" min="0" max="100" value="100">
                            </div>
                            <p> Precisión del parámetro</p>
                                    <select class="form-control little" id="precision-hora">
									<option>Hora exacta (Hora y minutos)</option>
									<option>Solo hora</option>
									<option>Intervalos de hora similares</option>
								</select>
                        </div>

                        <div class="form-config">
                            <label>Tiempo</label>
                            <p>Importancia del parámetro: <span id="value_tiempo"></span></p>
                            <div class="slidecontainer">
                                <input class="slider" id="slider-tiempo" type="range" min="0" max="100" step="5" value="100">
                            </div>
                        </div>

                        <div class="form-config">
                            <label>Tipo de vehículo</label>
                            <p>Importancia del parámetro: <span id="value_vehicle"></span></p>
                            <div class="slidecontainer">
                                <input class="slider" id="slider-vehiculo" type="range" min="0" max="100" value="100">
                            </div>
                        </div>

                        <div id="buttons-config">
                            <button type="button" id="btn-configuration-settings" class="btn btn-primary btn-block">Aceptar</button>
                        </div>
                    </div>

                    <div class="col-sm-12" id="cards">
						
                    </div>
					
					 <div class="col-sm-12" id="Graficos">
						<div class = "row">
							 <div class="col-sm-12" id="Grafico1">
							 </div>
							 <div class="col-sm-12" id="Grafico2">
							 </div>
							 <div class="col-sm-12" id="Grafico3">
							 </div>
							 <div class="col-sm-12" id="Grafico4">
							 </div>
							 <div class="col-sm-12" id="Grafico5">
							 </div>
							 <div class = "col-xs-12">
								<button type="button" class="btn btn-primary btn-block" onclick="mostrarTarjetasAccidentes()"> Ver datos de los accidentes</button>
							</div>
						</div>
                    </div>
					
					<div class="col-sm-12" id="Error">
						<div class="alert alert-warning"> 
							<strong>Atención!</strong> No existe la dirección de origen/destino </br>
							<a class="alert-link btn-form">Volver a introducir la ruta</a>
						</div>
					</div>
					
					<div class="col-sm-12" id="SaveConfig">
						<div class="alert alert-success"> 
							<strong> Configuración guardada con exito </strong> </br>
							<p> Para introducir una ruta pulse en el siguiente <a class="alert-link btn-form">enlace</a> </p>
						</div>
					</div>
					
                </div>

                <div class="row formulario">
                    <form>
                        <div class="col-md-12 form-group">
                            <label>Origen</label>
                            <div class='input-group' id='origin'>
                                <input type="text" class="form-control" id="origin-input" placeholder="Elige un punto de partida">
                                <span class="input-group-addon">
										<span class="glyphicon glyphicon-map-marker" id="glyphicon-map-marker-origin"></span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12  form-group">
                            <label>Destino</label>
                            <div class='input-group' id='destination'>
                                <input type="text" class="form-control" id="destination-input" placeholder="Elige un destino">
                                <span class="input-group-addon">
										<span class="glyphicon glyphicon-map-marker" id="glyphicon-map-marker-destination"></span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12 form-group">
                            <label>Fecha de partida</label>
                            <div class='input-group date' id='datepicker' data-placement="top" data-align="top" data-autoclose="true">
                                <input type='text' class="form-control" id="date-day" />
                                <span class="input-group-addon">
										<span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12 form-group">
                            <label>Hora de partida</label>
                            <div class='input-group' id='clockpicker' data-placement="top" data-align="top" data-autoclose="true">
                                <input type='text' class="form-control" id="time" />
                                <span class="input-group-addon">
										<span class="glyphicon glyphicon-time"></span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12 form-group">
                            <label>Tiempo</label>
                            <div class=" row icons">
                                <div class=" col-xs-3"> <i class="wi wi-fw wi-day-sunny" id="sunny" pulse="false"></i> </div>
                                <div class="col-xs-3"> <i class="wi wi-fw wi-strong-wind" id="wind" pulse="false"></i> </div>
                                <div class="col-xs-3"> <i class="wi wi-fw wi-raindrop" id="rain" pulse="false"></i> </div>
                                <div class="col-xs-3"> <i class="wi wi-fw wi-snowflake-cold" id="snowflake" pulse="false"></i> </div>
                            </div>
                        </div>
                        <div class="col-md-12 form-group">
                            <label>Tipo de vehículo</label>
                            <div class="row icons">
                                <div class="col-xs-3"> <i class="fa fa-car" id="car" pulse="false"></i> </div>
                                <div class="col-xs-3"> <i class="fa fa-motorcycle" id="moto" pulse="false"></i> </div>
                                <div class="col-xs-3"> <i class="fa fa-bicycle" id="bicycle" pulse="false"></i> </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="row buttons">
                    <div class="col-md-12">
                        <button type="submit" id="btn-risk" class="btn btn-primary btn-block" disabled="true">Calcular riesgo de la ruta</button>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 col-md-9" id="map">

            </div>
			
			<div class="col-sm-12" id="alternativeRoutes">
				<input id="btn-route-1" class="btn btn-success" type="button" value="Alternativa 1" onclick="getBetterRoute()" />
				<input id="btn-route-2" class="btn btn-warning" type="button" value="Alternativa 2" onclick="getMiddleRoute()" />
				<input id="btn-route-3" class="btn btn-danger" type="button" value="Alternativa 3" onclick="getWorstRoute()" />
			</div>

        </div>
    </div>
</body>

<script>
    var originAddress, destinationAddress, date, time, weather, vehicle;
    var distanceTotal = 0;
    var durationTotal = 0;
    var points_routes = [];

    var originLat = "";
    var originLng, destinationLat, destinationLng;

    var directionsService, directionsDisplay;
    var mapGlobal;
	var markers = [];
	var markerCluster = null;

    var coords;
    var locations;
    var nums;
	
	var valuesGlobal; 
	
    /* INFORMACION HORARIA*/

    $(document).ready(function() {
        $(".glyphicon-calendar").click(function() {
            $('#datepicker').datepicker({
                language: "es"
            });
        });
    });

    $(document).ready(function() {
        $(".glyphicon-time").click(function() {
            $('#clockpicker').clockpicker();
        });
    });

    function appendZero(number) {
        if (number < 10) {
            number = '0' + number
        }
        return number
    }

    $(document).ready(function() {
        var today = new Date();
        document.getElementById('date-day').value = appendZero(today.getDate()) + "/" + appendZero(today.getMonth() + 1) + "/" + appendZero(today.getFullYear());
        document.getElementById('time').value = appendZero(today.getHours()) + ":" + appendZero(today.getMinutes());
    });
    /* INFORMACION METEOROLOGICA */

    $(document).ready(function() {
        $(".wi-day-sunny").click(function() {
            $("#sunny").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#wind").attr("pulse", "false");
            $(".wi-strong-wind").css("color", "black");
            $("#rain").attr("pulse", "false");
            $(".wi-raindrop").css("color", "black");
            $("#snowflake").attr("pulse", "false");
            $(".wi-snowflake-cold").css("color", "black");
        });

        $(".wi-strong-wind").click(function() {
            $("#wind").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#sunny").attr("pulse", "false");
            $(".wi-day-sunny").css("color", "black");
            $("#rain").attr("pulse", "false");
            $(".wi-raindrop").css("color", "black");
            $("#snowflake").attr("pulse", "false");
            $(".wi-snowflake-cold").css("color", "black");
        });

        $(".wi-raindrop").click(function() {
            $("#rain").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#wind").attr("pulse", "false");
            $(".wi-strong-wind").css("color", "black");
            $("#sunny").attr("pulse", "false");
            $(".wi-day-sunny").css("color", "black");
            $("#snowflake").attr("pulse", "false");
            $(".wi-snowflake-cold").css("color", "black");
        });

        $(".wi-snowflake-cold").click(function() {
            $("#snowflake").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#wind").attr("pulse", "false");
            $(".wi-strong-wind").css("color", "black");
            $("#sunny").attr("pulse", "false");
            $(".wi-day-sunny").css("color", "black");
            $("#rain").attr("pulse", "false");
            $(".wi-raindrop").css("color", "black");
        });
    });

    function getSeletedWeather() {
        var sunnyPulse = $("#sunny").attr("pulse");
        var windPulse = $("#wind").attr("pulse");
        var rainPulse = $("#rain").attr("pulse");
        if (sunnyPulse == "true") {
            weather = "Soleado";
        } else if (windPulse == "true") {
            weather = "Vendabal";
        } else if (rainPulse == "true") {
            weather = "Lluvioso";
        } else {
            weather = "Nevado";
        }
        return weather;
    }


    /* INFORMACION MEDIO DE TRANSPORTE */

    $(document).ready(function() {
        $(".fa-car").click(function() {
            $("#car").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#moto").attr("pulse", "false");
            $(".fa-motorcycle").css("color", "black");
            $("#bicycle").attr("pulse", "false");
            $(".fa-bicycle").css("color", "black");
        });

        $(".fa-motorcycle").click(function() {
            $("#moto").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#car").attr("pulse", "false");
            $(".fa-car").css("color", "black");
            $("#bicycle").attr("pulse", "false");
            $(".fa-bicycle").css("color", "black");
        });

        $(".fa-bicycle").click(function() {
            $("#bicycle").attr("pulse", "true");
            $(this).css("color", "#627EB0");

            $("#car").attr("pulse", "false");
            $(".fa-car").css("color", "black");
            $("#moto").attr("pulse", "false");
            $(".fa-motorcycle").css("color", "black");
        });
    });

    function getSeletedVehicle() {
        var carPulse = $("#car").attr("pulse");
        var motoPulse = $("#moto").attr("pulse");
        if (carPulse == "true") {
            vehicle = "car";
        } else if (motoPulse == "true") {
            vehicle = "moto";
        } else {
            vehicle = "bike";
        }
        return vehicle;
    }

    /* CONFIGURACIÓN */

    $(document).ready(function() {
        $('#slider-hora').val(Cookies.get('wTime'));
        $('#slider-tiempo').val(Cookies.get('wWeather'));
		$('#slider-vehiculo').val(Cookies.get('wVehicle'));
		
		$("#precision-dia").val(Cookies.get('mDate'));
		$("#precision-location").val(Cookies.get('mLocation'));
		$("#precision-hora").val(Cookies.get('mTime'));
		
        var sliderFecha = document.getElementById("slider-fecha");
        var outputFecha = document.getElementById("value_fecha");
        outputFecha.innerHTML = sliderFecha.value;

        sliderFecha.oninput = function() {
            outputFecha.innerHTML = this.value;
        }

        var sliderHora = document.getElementById("slider-hora");
        var outputHora = document.getElementById("value_hora");
        outputHora.innerHTML = sliderHora.value;

        sliderHora.oninput = function() {
            outputHora.innerHTML = this.value;
        }

        var sliderTiempo = document.getElementById("slider-tiempo");
        var outputTiempo = document.getElementById("value_tiempo");
        outputTiempo.innerHTML = sliderTiempo.value;

        sliderTiempo.oninput = function() {
            outputTiempo.innerHTML = this.value;
        }

        var sliderVehiculo = document.getElementById("slider-vehiculo");
        var outputVehiculo = document.getElementById("value_vehicle");
        outputVehiculo.innerHTML = sliderVehiculo.value;

        sliderVehiculo.oninput = function() {
            outputVehiculo.innerHTML = this.value;
        }
    });

    $("#btn-configuration-settings").click(function() {
        getParametersConfiguration();
    });

    function getParametersConfiguration() {
        var mLocation = document.getElementById("precision-location").value;
        Cookies.set('mLocation', mLocation);

        var wDate = document.getElementById("slider-fecha").value;
        Cookies.set('wDate', wDate);
        var mDate = document.getElementById("precision-dia").value;
        Cookies.set('mDate', mDate);

        var wTime = document.getElementById("slider-hora").value;
        Cookies.set('wTime', wTime);
        var mTime = document.getElementById("precision-hora").value;
        Cookies.set('mTime', mTime);

        var wWeather = document.getElementById("slider-tiempo").value;
        Cookies.set('wWeather', wWeather);

        var wVehicle = document.getElementById("slider-vehiculo").value;
        Cookies.set('wVehicle', wVehicle);

        var myObj = {
            "mLocation": mLocation,
            "wDate": wDate,
            "mDate": mDate,
            "wTime": wTime,
            "mTime": mTime,
            "wWeather": wWeather,
            "wVehicle": wVehicle
        };
        var myJSON = JSON.stringify(myObj);

        $.ajax({
            method: 'POST',
            url: '/setConfiguration/',
            data: myJSON,
            dataType: 'json',
            success: function(response) {
                displayMessage()
            }
        })
    }


    /* BOTON PRINCIPAL */
	
	$(".form-control").keyup(function(){
		org_val = $("#origin-input").val()
		dst_val = $("#destination-input").val()
		if (org_val != "" && dst_val != ""){
			$('#btn-risk').attr("disabled", false);
		} else {
			$('#btn-risk').attr("disabled", true);
		}
	});

    $(" #btn-risk").click(function() {
		initMap();
        var originAddress = document.getElementById('origin-input').value;
        var destinationAddress = document.getElementById('destination-input').value;
        date = document.getElementById('date-day').value;
        time = document.getElementById('time').value;
        weather = getSeletedWeather();
        vehicle = getSeletedVehicle();

        convertToLatLng(originAddress, true);
        convertToLatLng(destinationAddress, false);

        distanceTotal = 0;
        durationTotal = 0;
        pointsToGo = []
        calculateAndDisplayRoute(originAddress, destinationAddress);

       mostrarTarjetasAccidentes()
    });
	
	function mostrarTarjetasAccidentes() {
		$(".formulario").hide()
        $(".buttons").hide()
		$("#Graficos").hide()
		$("#Error").hide()
		$("#SaveConfig").hide()
        $("#cards").show()
		$("#alternativeRoutes").show()
	}
	
    $("#btn-divide").click(function() {
        initMap()
        $(".formulario").hide()
        $("#configure").hide()
        $("#cards").hide()
		$("#Error").hide()
		$("#SaveConfig").hide()
		$("#Graficos").hide()
        $(".buttons").hide()
        $("#partition").show()
    });

    $("#btn-configure").click(function() {
        // Esconde los divs necesarios y muestra la configuracion 
        $(".formulario").hide();
        $("#partition").hide();
        $("#cards").hide();
		$("#Error").hide()
		$("#Graficos").hide();
        $(".buttons").hide();
		$("#SaveConfig").hide()
        $("#configure").show();

        // Recogemos el valor de las cookies
        $('#slider-fecha').val(Cookies.get('wDate'));
        value = $('#value_fecha').text(Cookies.get('wDate'));
        $('#slider-hora').val(Cookies.get('wTime'));
        value = $('#value_hora').text(Cookies.get('wTime'));
        $('#slider-tiempo').val(Cookies.get('wWeather'));
        value = $('#value_tiempo').text(Cookies.get('wWeather'));
        $('#slider-vehiculo').val(Cookies.get('wVehicle'));
        value = $('#value_vehiculo').text(Cookies.get('wVehicle'));
    });

    $(".btn-form").click(function() {
        $("#configure").hide();
        $("#partition").hide();
        $("#cards").hide();
		$("#Error").hide()
		$("#Graficos").hide();
		$("#SaveConfig").hide()
        $(".buttons").show();
        $(".formulario").show();
    });

    function zoom(lat, lng) {
        var pt = new google.maps.LatLng(lat, lng);
        mapGlobal.setCenter(pt);
        mapGlobal.setZoom(18);
        mapGlobal.setMapTypeId(google.maps.MapTypeId.HYBRID);
    }

    function vistaOriginal() {
        mapGlobal.setMapTypeId(google.maps.MapTypeId.ROADMAP);
    }

    $("#btn-numParts").click(function() {
		debugger;
        $.ajax({
            method: 'POST',
            url: '/divideMap/',
            data: {
                numDiv: document.getElementById("numPart").value
            },
            dataType: 'json',
            beforeSend: function() {
                $("#partition").hide();
                $("#loader").show();
            },
            success: function(response) {
                $("#loader").hide();
                $("#success").show();
                coords = response.coordenadas;
                locations = response.ubicaciones;
                nums = response.nAccidentes;
            }
        });
    });

    $("#btn-continue").click(function() {
        $("#success").hide();
		$("#Error").hide()
		$("#SaveConfig").hide()
        $(".formulario").show();
        $(".buttons").show();
        showAllPolygons();
    });



    function showAllPolygons() {
        for (i = 0; i < coords.length; i++) {
            addPolygon(coords[i])
        }

        markers = locations.map(function(location, i) {
            return new google.maps.Marker({
                map: mapGlobal,
                position: location,
                label: nums[i].toString()
            });
        });
    }

    function addPolygon(coordsArg) {
        new google.maps.Polygon({
            map: mapGlobal,
            paths: coordsArg,
            strokeColor: '#3A668D',
            strokeOpacity: 0.6,
            strokeWeight: 2,
            fillColor: '#3A668D',
            fillOpacity: 0.3,
            draggable: false,
            geodesic: true
        });
    }

    /* INICIALIZA EL MAPA (CENTRADO EN LONDRES) */

    function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
            mapTypeControl: false,
            center: {
                lat: 52.433184,
                lng: -1.716441
            },
            zoom: 7
        });
        mapGlobal = map;
        new AutocompleteDirectionsHandler(map);
    }

    /* AUTOCOMPLETADO DE LAS DIRECCIONES */
    function AutocompleteDirectionsHandler(map) {
        this.map = map;
        this.originPlaceId = null;
        this.destinationPlaceId = null;
        this.travelMode = 'DRIVING';

        var originInput = document.getElementById('origin-input');
        var destinationInput = document.getElementById('destination-input');

        directionsService = new google.maps.DirectionsService;
        directionsDisplay = new google.maps.DirectionsRenderer({
            polylineOptions: {
                strokeColor: "#C53682",
                strokeWeight: "5"
            }
        });
        directionsDisplay.setMap(map);

        var originAutocomplete = new google.maps.places.Autocomplete(
            originInput, {
                placeIdOnly: true
            });
        var destinationAutocomplete = new google.maps.places.Autocomplete(
            destinationInput, {
                placeIdOnly: true
            });

        this.setupPlaceChangedListener(originAutocomplete, 'ORIG');
        this.setupPlaceChangedListener(destinationAutocomplete, 'DEST');
    }

    AutocompleteDirectionsHandler.prototype.setupPlaceChangedListener = function(autocomplete, mode) {
        var me = this;
        autocomplete.bindTo('bounds', this.map);
        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            if (!place.place_id) {
                window.alert("Please select an option from the dropdown list.");
                return;
            }
            if (mode === 'ORIG') {
                me.originPlaceId = place.place_id;
            } else {
                me.destinationPlaceId = place.place_id;
            }
        });
    };

    /* CENTRAR EL MAPA EN LA POSICION ACTUAL */

    $(document).ready(function() {
        $("#glyphicon-map-marker-origin").click(function() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 51.507351,
                    lng: -0.127758
                },
                zoom: 14
            });
            showCurrentPosition(map, true);
        });
        $("#glyphicon-map-marker-destination").click(function() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 51.507351,
                    lng: -0.127758
                },
                zoom: 14
            });
            showCurrentPosition(map, false);
        });
    });


    /* OBTENER UBICACION ACTUAL */

    function showCurrentPosition(map, origin) {
        var dir = "ERROR";
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map.setCenter(pos);

                var marker = new google.maps.Marker({
                    map: map,
                    position: pos
                });
                dir = convertToAddress(pos.lat, pos.lng, origin);
            });
        } else {
            var infoWindow = new google.maps.InfoWindow({
                map: map
            });
            infoWindow.setPosition(pos);
            infoWindow.setContent('Error: The Geolocation service failed.');
        }
        return dir;
    }


    /* CONVERSOR POSICION (LATITUD, LONGITUD) A DIRECCION */

    function convertToAddress(latitud, longitud, origin) {
        var url = "https://maps.googleapis.com/maps/api/geocode/json";
        var params = "latlng=" + latitud + "," + longitud + "&key=AIzaSyBiOqO20btD4FUlRuPR5yObjsXHfefDRYw";
        url += '?' + params;

        var ajax_request = new XMLHttpRequest();
        ajax_request.onreadystatechange = function() {
            if (ajax_request.readyState == 4) {
                var jsonObj = JSON.parse(ajax_request.responseText);
                var dir = jsonObj.results[0].formatted_address;
                if (origin) {
                    $("#origin-input").val(dir);
                } else {
                    $("#destination-input").val(dir);
                }
            }
        }

        ajax_request.open("GET", url, true);
        ajax_request.send();
    }


    /* CONVERSOR DIRECCION A POSICION (LATITUD, LONGITUD) */

    function convertToLatLng(address, origin) {
        var url = "https://maps.googleapis.com/maps/api/geocode/json";
        var params = "address=" + address + "&key=AIzaSyBiOqO20btD4FUlRuPR5yObjsXHfefDRYw";
        url += '?' + params;

        var ajax_request = new XMLHttpRequest();
        ajax_request.onreadystatechange = function() {
            if (ajax_request.readyState == 4) {
                var jsonObj = JSON.parse(ajax_request.responseText);
                var pos = {
                    lat: jsonObj.results[0].geometry.location.lat,
                    lng: jsonObj.results[0].geometry.location.lng
                }
                if (origin) {
                    originLat = pos.lat;
                    originLng = pos.lng;
					alert("Latitud origen: " + originLat)
					alert("Longitud origen: " + originLng)
                } else {
                    destinationLat = pos.lat;
                    destinationLng = pos.lng;
					alert("Latitud destino: " + destinationLat)
					alert("Longitud destino: " + destinationLng)
                }
            }
        }
        ajax_request.open("GET", url, true);
        ajax_request.send();
    }

    /*function toggleBounce() {
        if (marker.getAnimation() !== null) {
            marker.setAnimation(null);
        } else {
            marker.setAnimation(google.maps.Animation.BOUNCE);
        }
    }*/
	
	function mostrarLeyenda(){
		$("#leyenda").toggleClass("hide")
		if ($("#leyenda").hasClass("hide")) {
			$("#btn-leyenda").text("Mostrar Leyenda")
			$("#btn-leyenda").css("background-color", "#269abc")
			$("#btn-leyenda").css("border-color", "#1b6d85")
		} else {
			$("#btn-leyenda").text("Ocultar Leyenda")
			$("#btn-leyenda").css("background-color", "#D9534F")
			$("#btn-leyenda").css("border-color", "#D43F3a")
		}
	}

	function showAccidentsCards(locations, values) {
		
		var html = '<button type="button" id ="btn-leyenda" class="btn btn-info btn-block" onclick="mostrarLeyenda()">Mostrar Leyenda</button>'
		
		html += '<div id = "leyenda" class="col-xs-12 hide">'+
					'<div class="row">'+ 
						'<div class="col-xs-3"> <img src="../static/images/x.png" width="40px" height="60px"> </div>'+
						'<div class="col-xs-9 center leyenda_dist"> <p> Accidente con X características en común </p> </div>' +
					'</div> <hr/>' +
					'<div class="row">'+ 
						'<div class=" col-xs-3 center"> <i class="wi wi-fw wi-day-sunny icons_2"></i> <p> Soleado </p> </div>' + 
                        '<div class="col-xs-3 center"> <i class="wi wi-fw wi-strong-wind icons_2"></i> <p> Viento </p> </div>' +
                        '<div class="col-xs-3 center"> <i class="wi wi-fw wi-raindrop icons_2"></i> <p> Lluvioso </p> </div>' +
                        '<div class="col-xs-3 center"> <i class="wi wi-fw wi-snowflake-cold icons_2"></i> <p> Nevado </p>  </div>' +
					'</div>'+
					'<div class="row">'+ 
						'<div class="col-xs-3 center"> <i class="fa fa-car icons_2"></i> <p> Coche </p> </div>'+
						'<div class="col-xs-3 center"> <i class="fa fa-motorcycle icons_2"></i> <p> Moto </p></div>'+
						'<div class="col-xs-3 center"> <i class="fa fa-bicycle icons_2"></i> <p> Bicicleta </p> </div>'+
					'</div>'+
				'</div>'
		
		for (j = 0; j < values.length; j++) {
			lat = locations[j]['lat']
			lng = locations[j]['lng']
			
			weather = values[j]['weather']
			vehicle = 'car'
			
			if (vehicle == 'car'){
				vehicle_html = '<i class="fa fa-car"></i>'
			} else if (vehicle == 'moto'){
				vehicle_html = '<i class="fa fa-motorcycle"></i>'
			} else {
				vehicle_html = '<i class="fa fa-bicycle"></i>'
			}
			
			if (weather == 'Soleado'){
				weather_html = '<i class="wi wi-fw wi-day-sunny"></i>'
			} else if (weather == 'LLuvioso'){
				weather_html = '<i class="wi wi-fw wi-raindrop"></i>'
			} else if (weather == 'Nevado'){
				weather_html = '<i class="wi wi-fw wi-snowflake-cold"></i>'
			} else {
				weather_html = '<i class="wi wi-fw wi-strong-wind"></i>'
			}
			
			html += '<div class="col-xs-6 panel panel-default">' +
						'<div class="row panel-body">' +
							'<div class="col-xs-12" id="cards-date">' + 
								values[j]['date'] + 
							'</div>' +
							'<div class="col-xs-3 icons_2">'+ weather_html + '</div>' + 
							'<div class="col-xs-3 icons_2">'+ vehicle_html + '</div>' + 
							'<div class="col-xs-6">' +
								'<button type="button" class="btn btn-info" onclick="zoom(' + lat + ',' + lng + ')">Ver</button>'+
							'</div>' +
						'</div>' +
					'</div>'
		}
		
		html += '<div class = "col-xs-12 womargin">'+
					'<div class="col-xs-6">'+
						'<button type="button" id="btnOriginalZoom" class="btn btn-primary btn-block" onclick="vistaOriginal()">Vista original</button>'+
					'</div>'+
					'<div class="col-xs-6">' +
						'<button type="button" class="btn btn-primary btn-block" onclick="showAllGraphics(1)">Ver gráficos</button>'+
					'</div>'+
				'</div>'
				
		$('#cards').empty();
		$('#cards').append(html);
	}
	
	function displayError() {
		$("#Error").show()
		$("#configure").hide()
		$("#success").hide()
		$("#loader").hide()
		$("#Graficos").hide()
		$("#SaveConfig").hide()
		$("#partition").hide()
		$("#cards").hide()	
	}
	
	function displayMessage() {
		$("#Error").hide()
		$("#configure").hide()
		$("#success").hide()
		$("#loader").hide()
		$("#Graficos").hide()
		$("#SaveConfig").show()
		$("#partition").hide()
		$("#cards").hide()	
	}
	
	
	function showColorMarkers(coincidences, locations) {
		markers = []
		/* ICONOS COCHES */
		var icon1 = {
			url: "static/images/1.png",
			scaledSize: new google.maps.Size(50, 70)
		};
		var icon2 = {
			url: "static/images/2.png",
			scaledSize: new google.maps.Size(50, 70)
		};
		var icon3 = {
			url: "static/images/3.png",
			scaledSize: new google.maps.Size(50, 70)
		};
		var icon4 = {
			url: "static/images/4.png",
			scaledSize: new google.maps.Size(50, 70)
		};
		var icon5 = {
			url: "static/images/5.png",
			scaledSize: new google.maps.Size(50, 70)
		}; 
		
		//i = 0
		for (i = 0; i < locations.length; i++) {
			var marker 
			if (coincidences[i] == 1) {
				marker = new google.maps.Marker({
					position: locations[i],
					icon: icon1,
					title:"Una caracerística en común"
				});
			} else if (coincidences[i] == 2) {
				marker =  new google.maps.Marker({
					position: locations[i],
					icon: icon2,
					title:"Dos caracerísticas en común"
				});
			} else if (coincidences[i] == 3) {
				marker =  new google.maps.Marker({
					position: locations[i],
					icon: icon3,
					title:"Tres caracerísticas en común"
				});
			} else if (coincidences[i] == 4) {
				marker = new google.maps.Marker({
					position: locations[i],
					icon: icon4,
					title:"Cuatro caracerísticas en común"
				});
			} else {
				marker = new google.maps.Marker({
					position: locations[i],
					icon: icon5,
					title:"cinco caracerísticas en común"
				});
			}
			markers.push(marker)
			marker.setMap(mapGlobal)
		}
		
		markerCluster = new MarkerClusterer(mapGlobal, markers, {
			imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
		});
	}
    /* MOSTRAR LA RUTA */
    function calculateAndDisplayRoute(originAdd, destinationAdd) {
        points_routes = []
        directionsService.route({
            origin: originAdd,
            destination: destinationAdd,
            provideRouteAlternatives: true,
            travelMode: 'DRIVING'
        }, function(response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
                var i, j;
                var nRoute; // Variable que determina el numero de rutas disponibles
				var points_in_route = {}
                for (nRoute = 0; nRoute < 3; nRoute++) {
					if(nRoute < response.routes.length){
						var pointsToGo = [];
						var pasos = response.routes[nRoute].legs[0].steps;
						for (i = 0; i < pasos.length; i++) {
							var paso = pasos[i];
							for (j = 0; j < paso.lat_lngs.length; j++) {
								pointsToGo.push(paso.lat_lngs[j]);
							}
							distanceText = paso.distance.text.replace(',', '.');
							distanceLenght = (paso.distance.text).length;
							if (distanceText.includes("km")) {
								distanceActual = parseFloat(distanceText.substr(0, distanceLenght - 3)) * 1000;
								distanceTotal = distanceTotal + distanceActual;
							} else {
								distanceTotal = distanceTotal + parseInt(distanceText.substr(0, distanceLenght - 2));
							}
							durationText = paso.duration.text;
							durationLenght = (paso.duration.text).length;
							if (durationText.includes("sg")) {
								durationTotal = durationTotal + parseFloat(durationText.substr(0, durationLenght - 3) / 60);
							} else {
								durationTotal = durationTotal + parseInt(durationText.substr(0, durationLenght - 4));
							}
						}
						points_in_route[nRoute] = pointsToGo
					}
					
                }

				var data = {
                    "Day": date,
                    "Time": time,
                    "Weather": weather,
                    "Vehicle": vehicle,
                    "Distance": distanceTotal,
                    "Duration": durationTotal,
                    "Points": points_in_route
                };
                var myJSON = JSON.stringify(data);
                
                $.ajax({
                    method: 'POST',
					async: false,
                    url: '/getSquares/',
                    data: {json_data: JSON.stringify(data)},
                    dataType: 'json',
                    success: function(response) {
						valuesGlobal = response.values
						directionsDisplay.setRouteIndex(response.index)
                        showAccidentsCards(response.positions, response.values)
						showColorMarkers(response.coincidences, response.positions)
                    }
                });
            } else {
				displayError()
            }
        });
    }
	
	
	function getBetterRoute() {
		$.ajax({
			method: 'POST',
			async: false,
			url: '/getBestRoute/',
			dataType: 'json',
			success: function(response) {
				deleteMarkers()
				valuesGlobal = response.values
				directionsDisplay.setRouteIndex(response.index)
				showAccidentsCards(response.positions, response.values)
				showColorMarkers(response.coincidences, response.positions)
				showAllGraphics(0)
			}
		});
	}
	
	function getWorstRoute() {
		$.ajax({
			method: 'POST',
			async: false,
			url: '/getWorstRoute/',
			dataType: 'json',
			success: function(response) {
				deleteMarkers()
				valuesGlobal = response.values
				directionsDisplay.setRouteIndex(response.index)
				showAccidentsCards(response.positions, response.values)
				showColorMarkers(response.coincidences, response.positions)
				showAllGraphics(0)
			}
		});
	}
	
	function getMiddleRoute() {
		$.ajax({
			method: 'POST',
			async: false,
			url: '/getMiddleRoute/',
			dataType: 'json',
			success: function(response) {
				deleteMarkers()
				valuesGlobal = response.values
				directionsDisplay.setRouteIndex(response.index)
				showAccidentsCards(response.positions, response.values)
				showColorMarkers(response.coincidences, response.positions)
				showAllGraphics(0)
			}
		});
	}

	// Deletes all markers in the array by removing references to them.
	function deleteMarkers() {
		markerCluster.removeMarkers(markers, true)
		markerCluster.resetViewport(true)
		for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
		markers = [];
	  }
	  
	 
	 function showAllGraphics(flag) {
		if (flag == 1){
			$('#cards').hide()
			$('#Graficos').show()
		}
		
		hours = []
		weathers = []
		severitys = []
		
		for(i = 0; i < valuesGlobal.length; i++){
			hour = valuesGlobal[i].date
			hour = hour.split(" ")[1]
			hours[i] = hour.split(":")[0]
			weathers[i] = valuesGlobal[i].weather
			severitys[i] = valuesGlobal[i].severity
		}
			
		var data = {
			"Hours": hours,
			"Weathers": weathers, 
			"Severitys": severitys
		};
		
		var myJSON = JSON.stringify(data);
		$.ajax({
			method: 'POST',
			async: false,
			url: '/getGraphicValues/',
			data: {json_data: JSON.stringify(data)},
			dataType: 'json',
			success: function(response) {
				graficoPorHoras(response.hours)
				graficoPorClima(response.weathers)
				graficoPorSeveridad(response.severitys)
			}
		});
		
	 }
	 
	 function graficoPorHoras(values){
		Highcharts.chart('Grafico1', {
			chart: {type: 'column', height: 300},
			title: {text: 'Distribución por horas'},
			xAxis: {
				type: 'category',
				labels: {
					rotation: -45,
					style: {fontSize: '13px', fontFamily: 'Verdana, sans-serif'}
				}
			},
			yAxis: {min: 0, title: {text: 'Numero de accidentes'}},
			legend: {enabled: false},
			credits: {enabled: false},
			exporting: {enabled: false},
			series: [{data: values}]
		});
	 }
	 
	 function graficoPorClima(values){
		Highcharts.setOptions({
			colors: ['#72C9E7', '#FFFDAB', '#ACF1A0', '#F6D0FD', '#FF8000']
		});

		Highcharts.chart('Grafico2', {
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				height: 300,
			},
			legend: {
				alignColumns: false,
				itemDistance: 5
			},
			title: {text: 'Distribución por clima'},
			tooltip: {pointFormat: '{point.y} accidentes' + ' ({point.percentage:.1f}%)'},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				}
			},
			credits: {enabled: false},
			exporting: {enabled: false},
			series: [{
				colorByPoint: true,
				data: values
			}]
		});
	 }
	 
	 
	 function graficoPorSeveridad(values){
		Highcharts.setOptions({
			colors: ['#72C9E7', '#FFFDAB', '#ACF1A0', '#F6D0FD', '#FF8000']
		});

		Highcharts.chart('Grafico4', {
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				height: 300,
			},
			legend: {
				alignColumns: false,
				itemDistance: 5
			},
			title: {text: 'Distribución por severidad'},
			tooltip: {pointFormat: '{point.y} accidentes' + ' ({point.percentage:.1f}%)'},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				}
			},
			credits: {enabled: false},
			exporting: {enabled: false},
			series: [{
				colorByPoint: true,
				data: values
			}]
		});
	 }
		
	 function graficoPorVehiculo(){
		Highcharts.setOptions({
			colors: ['#72C9E7', '#FFFDAB', '#ACF1A0', '#F6D0FD']
		});

		Highcharts.chart('Grafico4', {
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				height: 300,
			},
			legend: {
				alignColumns: false,
				itemDistance: 5
			},
			title: {
				text: 'Distribución por tipo de vehículo'
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				}
			},
			credits: {
				enabled: false
			},
			exporting: {enabled: false},
			series: [{
				name: 'Brands',
				colorByPoint: true,
				data: [{
					name: 'Coche',
					y: 61.41
				}, {
					name: 'Moto',
					y: 11.84
				}, {
					name: 'Bicicleta',
					y: 10.85
				}, {
					name: 'Otro',
					y: 4.67
				}]
			}]
		});
	}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBuubLxOn2GbTWCa1s2yrdRIchSBC_8csk&libraries=places&callback=initMap">
</script>

</html>